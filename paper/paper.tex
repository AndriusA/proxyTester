% This version uses the latex2e styles, not the very ancient 2.09 stuff.
\documentclass{sig-alternate-10pt}
\usepackage{endnotes,url}
%\usepackage{sig-alternate-10pt,endnotes}
\usepackage{epsfig}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{lipsum}
\usepackage{algorithm}
\usepackage{algorithmic}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{verbatim}
% Replaced by subfig package
% \usepackage{subfigure}
\usepackage{subfig}
\usepackage{epstopdf}
\usepackage{cite}
\usepackage{array}
\usepackage{multirow}
\usepackage{listings}


\captionsetup[figure]{labelfont={small},textfont={small}}

%\pdfpagewidth 8.5in
%\pdfpageheight 11in
%\baselineskip=12.5pt
%\setlength{\pdfpagewidth}{8.5in}
%\setlength{\pdfpageheight}{11in}
%\usepackage{pdfdraftcopy}

% To import classical math notation used
\input{mathnotation.tex}
% Package for date and time presentation
\usepackage{datetime}
\newcommand{\datation}{\today, \xxivtime}

\def\full{0}        % set 1 for a full tech report version
                    % set 0 for submission version
\def\shownotes{1}   % set 1 for version with author notes
                    % set 0 for no notes
\def\anon{1}        % set 1 to anonymize
                    % set 0 for acks and author names

%%%%%%%  Author Notes %%%%%%%
%
\ifnum\shownotes=1
\newcommand{\authnote}[2]{{ $\ll$\textsf{\footnotesize #1 notes: #2}$\gg$}}
\else
\newcommand{\authnote}[2]{}
\fi
\newcommand{\Anote}[1]{{\authnote{Andrius}{#1}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\namedref}[2]{#1~\ref{#2}}
\newcommand{\tableref}[1]{\namedref{Table}{#1}}
\newcommand{\sectionref}[1]{\namedref{Section}{#1}}
\newcommand{\appendixref}[1]{\namedref{Appendix}{#1}}
\newcommand{\theoremref}[1]{\namedref{Theorem}{#1}}
\newcommand{\remarkref}[1]{\namedref{Remark}{#1}}
\newcommand{\definitionref}[1]{\namedref{Definition}{#1}}
\newcommand{\figureref}[1]{\namedref{Figure}{#1}}
\newcommand{\lemmaref}[1]{\namedref{Lemma}{#1}}
\newcommand{\claimref}[1]{\namedref{Claim}{#1}}
\newcommand{\propositionref}[1]{\namedref{Proposition}{#1}}
\newcommand{\constructionref}[1]{\namedref{Construction}{#1}}
\newcommand{\corollaryref}[1]{\namedref{Corollary}{#1}}
\newcommand{\equationref}[1]{\namedref{Equation}{#1}}
%
\newtheorem{theorem}{Theorem}[section]
\newtheorem{definition}[theorem]{Definition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{claim}[theorem]{Claim}
\newtheorem{obs}[theorem]{Observation}
%


\providecommand{\vs}{vs. }
\providecommand{\ie}{\emph{i.e.,} }
\providecommand{\eg}{\emph{e.g.,} }
\providecommand{\cf}{\emph{cf.,} }
\providecommand{\resp}{\emph{resp.,} }
\providecommand{\etal}{\emph{et al.}}   %Removed trailing space here; usually want non-breaking space with following reference
\providecommand{\etc}{\emph{etc.}}      % No trailing space here either
\providecommand{\mypara}[1]{\smallskip\noindent\emph{#1} }
\providecommand{\myparab}[1]{\smallskip\noindent\textbf{#1} }
\providecommand{\myparasc}[1]{\smallskip\noindent\textsc{#1} }
\providecommand{\para}{\smallskip\noindent}

\newtheorem{axiom}{{\bf  Axiom}}
\newtheorem{defin}{{\bf  Definition}}
\newtheorem{proposition}{Proposition}

\usepackage{enumitem}
\setlist{nolistsep}

%Model parameters

\usepackage[breaklinks=true]{hyperref}
\frenchspacing
\begin{document}

%don't want date printed
\date{}


%make title bold and 14 pt font (Latex default is non-bold, 16 pt)
\title{NoTCP: steganographic tricks to bypass middleboxes}
\ifnum\anon=1
\author{[Paper: \#137]}% \hspace{0.2cm} \ampmtime ]}
\else
\numberofauthors{3}
\author{
\alignauthor Andrius Aucinas\\
\affaddr{University of Cambridge} 
\and
\alignauthor Jon Crowcroft\\
\affaddr{University of Cambridge}
\and
\alignauthor Narseo Vallina-Rodriguez\\
\affaddr{ICSI}
}
\fi
%for single author (just remove % characters)

    
% end author
\maketitle
% Use the following at camera-ready time to suppress page numbers.
% Comment it out when you first submit the paper for review.
%\thispagestyle{empty}
\begin{abstract}
TCP is the de facto transport protocol in the Internet. However it has many limitations that make it ill suited to the modern world of high mobility and multi-homing. Protocol optimizations and filtering performed by middleboxes make extension deployment challenging which has led researchers to explore new ways of exchanging control information between endpoints. In this paper we explore steganographic approaches to smuggle information between endpoints to avoid middlebox interference. We design NoTCP -- a mechanism which uses the TCP header fields in combinations that are currently have no defined semantics to hide a small amount of control information from middleboxes and hence bootstrap a control channel. We also present a preliminary study showing how the mechanism works across cellular and WiFi networks.
\end{abstract} 

\section{Introduction}
\label{section:intro}

TCP is everywhere in the Internet and it carries the overwhelming majority of bytes~\cite{John:2007dv}. TCP is used for all types of traffic from bulk download to video streaming to instant messaging. Over the last decade a number of new protocols have been proposed to replace TCP. However many middle boxes will actively block or interfere with traffic that does not conform to their view of what TCP should look like. Consequently few of these protocols have found any leverage.

Modern networks necessitate new functionality, such as Multipath Connectivity~\cite{Handley:vj} for multi-homed devices and ubiquitous traffic encryption~\cite{Mazieres:uz}). The applications of exchanging control information between endpoints range from new secure extensions~\cite{Rescorla:R080FoGB} to exchanging information about endpoints for connection parameter tuning (\eg initial congestion window~\cite{Dukkipati:2010hs}) to designing better coordination for long-lived connections to save mobile device energy~\cite{Aucinas:2013uk}.

One of the main requirements to extend and modify TCP is the ability to exchange control information. Traditionally this is what TCP option space was used for. However option space is limited, heavily contended~\cite{Handley:vj,Mazieres:uz} and troubled by network middleboxes~\cite{Honda,Guha2005tb,UntoldMiddlebox2011}.

We believe that the solution is to work round the middle boxes by using steganographic techniques~\cite{Frczek:2012dl,Zielinska:2014fn,Rowland:1997vq,Murdoch:2005fz} to conceal control information within the TCP header. This could be as simple as using one of the currently undefined flags to toggle the meaning of existing fields, through to using the urgent pointer without setting the urgent flag or even hashing information into the initial sequence number in much the way that SYN Cookies~\cite{Eddy:2007to} do currently.

This paper makes three main contributions. 
\begin{enumerate}
\item We discuss the possible ways to conceal information in the TCP header and give some examples of the extensions this could enable
\item We describe a measurement application that we have written to run on Android phones for a large-scale study.  
\item We present the results of an initial small scale deployment of our application.
\end{enumerate}

We use our initial study to design a way of exchanging a small amount of control information successfully across all of our tested networks and show a potential mechanism to use it for bootstrapping a full control stream currently missing from TCP. We hope that our successful results will motivate the research community into exploring the full range of possibilities in this space.

\section{Candidate protocol changes}
\label{sec:protocolChanges}

\begin{figure}[t!]
\centering
\small{
\includegraphics[width=\columnwidth]{figs/tcp-header}
\vspace{-3mm}
\caption{TCP Header with overloaded fields and extra control information (Checksum Correction / Control Stream) in payload}
\label{fig:header}
}
\vspace{-2mm}
\end{figure}

Figure~\ref{fig:header} shows TCP header with fields that we propose for reuse and define later in the paper. However, the structure of TCP header is very simple and gives are few choices for hiding extra control information:
\begin{itemize}
    \item Header fields without corresponding flags to have no meaning to legacy implementations.
    \item Assigning one or more of the reserved field bits.
    \item Defining new semantics for valid header fields.
\end{itemize}

\subsubsection*{Unset Flags}
\label{sec:unset}

The only header fields that may not have a meaning depending on the corresponding flag are \emph{Urgent Pointer} and \emph{Acknowledgment Number}. The latter must always be set after the initial SYN packet.

The general recommendation is to not use It is recommended against the use of the urgent mechanism~\cite{Gont:2011vi}, therefore it could be reused for other purposes if both endpoints understand the new semantics. On the other hand, it is common practice by Network Intrusion Detection Systems (NIDS) on enterprise networks to reset the field as it makes it difficult to track application-layer data~\cite{seolma}. Better yet, the field becomes \emph{Non-Urgent}~\cite{Kuhlewind:2014vd} when URG is not set -- it has no meaning for legacy implementations and can be redefined.

Acknowledgment field is only available in the initial SYN packet. It must therefore be combined with another mechanism to acknowledge control information unless TCP Simultaneous Open is used. Simultaneous open is still viable in most cellular networks~\cite{UntoldMiddlebox2011}, but we also explore other options.

\subsubsection*{Reserved bits}

Only 3 TCP Reserved bits have not been allocated since the three ECN bits (ECN, CWR and experimental NS)~\cite{Floyd:up,Ely:uc} that are still not universally implemented~\cite{Kuhlewind:2013hr}.

Due to simplicity and non-interference with legacy implementations there are proposals that make use of them. One suggestion for reducing Web latency~\cite{Flach:2013uy} by mitigating the effects of a small number of lost packets for short connections is to send multiple copies of packets. The solution avoids triggering fast retransmit by such duplicate acknowledgments by marking them as duplicates in a reserved flag.

\subsubsection*{Value-specific semantics}

The remaining choice is to encode information within valid header fields. It involves generating packets with specific values for initial sequence numbers, window size or checksums. Arguably it is an acceptable choice if deployable in today's networks.

Initial sequence numbers must be hard to predict as they provide a measure of security and until strong encryption. Stronger security measures such as TCPCrypt are better suited for this purpose, but are not universally adopted. Adding information to the field to be easily decoded by the receiver makes it predictable and weakens already problematic security~\cite{Qian:2012bj,Bellovin:uz,Qian:2012wb}. 

Window size is potentially a better candidate, especially if used during connection setup phase since data is not typically transmitted during the handshake. Using lower-order bits for control information would prevent flow control from operating properly, but higher-order bits could instead be given up when window scaling option is used to compensate for the decrease of advertised window size. Using the field risks interfering both with TCP flow control mechanism as well as window size optimizations by the network~\cite{Kopparty:2002ht,Chakravorty:2003dm} performed \eg by Citrix ByteMobile Proxy~\cite{Ha:2006td}. 

There are multiple benefits to using the checksum field. Firstly, it is only used for error detection. It may be unnecessary when reliable error detection is done at the layer below, however link-level checks have been shown unreliable~\cite{Stone:2000fc}. Instead, it may be replaced with extensions' separate, potentially stronger mechanisms \eg MPTCP DSS checksum and TCPCrypt Message Authentication Code) or left for the upper layer.

Secondly, checksum operations are efficient as they only involve one's complement addition. We show later in the paper (Section~\ref{sec:protocol}) how checksums can be generated in a way that the intended value is recovered by the receiver after traversing multiple layers of Network Address Translation (NAT).

\section{Methodology}

To verify current network behavior we have developed an Android application distributed through the \emph{Google Play Store} to collect data from volunteers. It contains a simplified implementation of TCP to generate packet sequences that appear valid to network middleboxes: three-way handshake, data exchange and connection teardown. It allows us to modify various header fields to our purposes and check the values received by the other endpoint. We control both endpoints of each connection, therefore we can detect changes from sent values received by the other endpoint.

The testing setup is:
\begin{itemize}
    \item Android application with a simplified TCP stack using Raw Unix sockets for full control over the TCP header (\emph{SOCK\_RAW}). It manages the tests and sends results back to our servers. 
    \item Server instrumented to generate specific responses to incoming packets based on header and payload values. We currently use a dedicated test server in a single location and no firewalls or NATs.
\end{itemize}

Non-transparent proxies are a major problem for extension deployment, therefore we used another well know and widely deployed tool to detect proxies on our tested networks. We implemented previously developed techniques~\cite{Weaver:RHwbx82O} and run the test separately. The primary one was non-responsive server test: the server is instrumented not to respond to SYN, therefore if connection succeeds it is to a proxy on the path. We repeated these tests on different destination ports and found that proxying can be specific to certain port numbers.

%Transparency of proxies may also depend on higher-level protocols, therefore we checked for HTTP proxies using techniques proposed in the work, including checking content and header changes, different IP addresses seen for HTTP or non-HTTP traffic and whether non-HTTP traffic on HTTP port is filtered.

\subsection{Limitations}

Potential limitations of our methodology include that we do not consider packet splitting and coalescing. Our goal is to exchange control information within packet headers to avoid dealing with it altogether. To ensure that splitting does not happen during our tests we do not send more than a few bytes of data and the exchange only consists of a single message sent each way. Due to the same reason we do not take congestion control into account either.

Raw sockets operate in parallel to the kernel network stack. We had to suppress reset packets generated by the kernel in response to TCP packets from sessions it is not aware of. We also had to choose local port numbers unused by the kernel. We chose them randomly from the unprivileged port range and relied on other error detection mechanisms preventing invalid packet delivery to the applications.

\section{Network characteristics}
\label{sec:network}

\begin{table*}[t]
{\small
\begin{center}
\begin{tabular}{| l | >{\centering\arraybackslash}m{1.2cm} | >{\centering\arraybackslash}m{1.6cm} | >{\centering\arraybackslash}m{1.6cm} | >{\centering\arraybackslash}m{1.8cm} | >{\centering\arraybackslash}m{1.6cm} | >{\centering\arraybackslash}m{1.5cm} | >{\centering\arraybackslash}m{1.5cm} | >{\centering\arraybackslash}m{1.5cm} | >{\centering\arraybackslash}m{1.cm} | }
\hline
    \textbf{Net ID} & \textbf{Country} & \textbf{Port-specific} & \textbf{Validate checksum} & \textbf{Drop SYN-ACK data} & \textbf{Normalize SYN Ack number}  & \textbf{Normalize Urgent Pointer} & \textbf{Normalize Reserved} & \textbf{Remap Sequence} \\ \hline \hline
    % Univ Helsinki WiFi
    WiFi edu 1      & Finland               &                        & \checkmark                 &                        &                         &                        &                             &                     \\ \hline
    % Eduroam
    WiFi edu 2      & UK               &                        &                            & \checkmark             &                         & \checkmark             &                             & \checkmark          \\ \hline
    % wgb
    WiFi pub 1      & UK               &                        &                            &                        &                         &                        &                             &                     \\ \hline
    % MKSW germany (carlos)
    WiFi pub 2      & Germany               &                        & \checkmark                 & \checkmark             &                         &                        &                             &                     \\ \hline
    % Virgin home
    WiFi res 1      & UK               &                        & \checkmark                 &                        &                         &                        &                             &                     \\ \hline
    % TEO Lt
    WiFi res 2      & Lithuania               &                        & \checkmark                 & \checkmark             &                         &                        &                             &                     \\ \hline
    % Telefonica Free
    WiFi ent 1      & Spain               &                        & \checkmark                 & \checkmark             &                         &                        &                             &                     \\ \hline
    \hline
    % Finland internet.saunalahti
    Cellular 1      & Finland               &                        &                            &                        &                         &                        &                             &                     \\ \hline
    % GiffGaff
    Cellular 2      & UK               &  443, 993              & -                          & -                      & -                       & -                      & -                           & -                   \\ \hline
    % E-Plus germany
    Cellular 3      & Germany               &                        &                            &                        &                         & \checkmark             &                             & \checkmark          \\ \hline
    % EE/T-Mobile
    Cellular 4      & UK               &               80, 443  & -                          & -                      & -                       & -                      & -                           & -                   \\ \hline
    % Three UK
    Cellular 5      & UK               &                        & \checkmark                 &                        &                         &                        &                             &                     \\ \hline
    % Omnitel LT
    Cellular 6      & Lithuania               &                        & \checkmark                 &                        &                         &                        &                             &                     \\ \hline
\end{tabular}
\end{center}
}
\vspace{-3mm}
\caption{Network behavior observed through tests generating custom TCP packets. A dash means different cases observed based on port numbers.}
\label{tab:networks}
\vspace{-2mm}
\end{table*}

We show our collected results in Table~\ref{tab:networks}. Since we were focusing on mobile applications, in our preliminary study we collected results across public, residential, university and enterprise WiFi networks as well as 6 cellular networks in 4 different countries.

The results include networks that did not filter any modifications (only one WiFi and two cellular nets), and ones that discarded packets with invalid checksums, normalized particular fields - either dropped packets or reset to different values - and whether NATs performed only port number remapping or also changed sequence numbers. Only one network provided clients with a global IP (WiFi edu 2).

Traditional NATs~\cite{Egevang:tu} perform a simple checksum recalculation: subtract the old header fields from the checksum and add the new ones. The networks that deliver packets with invalid checksum only do that. Otherwise they would detect and drop an invalid packet.

A bigger issue we have discovered is that middleboxes do not always respect the standard and drop SYN-ACK packets with payload. We did not see it on cellular networks, but most WiFi (4/7) behaved in such way even though the standard allows handshake packets to contain payload~\cite{Postel:3EDyoxP_,Chu:2011tn}.

% \begin{quotation}
%     Although these examples do not show connection synchronization using data-carrying segments, this is perfectly legitimate
% \end{quotation}

As discussed in Section~\ref{sec:unset}, we can squeeze in a few extra bits of information by defining meaning to header fields when corresponding flags are not set. None of our tested networks filtered Acknowledgment Number field for the initial SYN packet on non-proxied paths and only two networks discarded packets with Urgent Pointer set without URG flag.

Finally we tested interaction reserved header bits. We separated our tests to handshake and data exchange parts as well as set each bit individually, however we did not observe any differences. All networks appear to pass reserved bits on non-proxied connections.


\subsection{Port-specific middlebox behavior}
\label{sec:portspec}

To differentiate between general behavior of particular network and application-specific optimizations (\eg HTTP acceleration) we repeat our tests on a few application-specific ports as well as a random one:
\begin{itemize}
    \item 80, 443 - HTTP and HTTPS
    \item 993 - Secure IMAP port
    \item 5228 - Google cloud messaging port
    \item 6969 - random port number
    \item 8000 - common HTTP proxy port number
\end{itemize}

We only observed port-specific behavior on two networks: \emph{Cellular 2} and \emph{Cellular 4}. In the first case, traffic travels over SSL ports (443, 993) unmodified except for packets with invalid checksum being dropped. Our traffic was not encrypted. An increasing proportion of traffic is served over SSL, making the value of such proxies questionable: a commercially deployed HTTP accelerator reports the proportion of HTTPS requests to be close to that of HTTP\footnote{\url{http://db.awazza.com/users/global/}}.

We confirmed the middlebox on Cellular 2 to be a ByteMobile proxy. It replaces the original connections with new ones, adding options not present in original packets, changing window size and resetting other fields to new values to optimize TCP for cellular networks~\cite{Ha:2006td}. Such behavior makes deployment of any protocol modifications or extensions difficult -- we verified that \eg TCPCrypt does not work on this network. We do not currently have an estimate of how widespread ByteMobile proxies are as we only observed them on one network.

In the second case, traffic was only modified when going to ports 80 and 443. The network likely optimizes HTTP traffic and drops any non-HTTP traffic. In general port-specific behavior appears related to proxies.

\subsection{Non-transparent proxies}
\label{sec:proxies}

Proxies potentially change every aspect of the original connection, rewrite or filter header values they do not recognize and hiding any information within the packet becomes difficult. We checked for them in our tested networks on a number of popular port numbers:
21, 22, 25, 80, 110, 135, 139, 143, 161, 443, 445, 465, 585, 587, 993, 995, 1194, 1723, 5060, 6881, 9001.

\begin{table}[t!]
{\small
\begin{center}
\begin{tabular}{| l | >{\centering\arraybackslash}m{1.8cm} | >{\centering\arraybackslash}m{3.7cm} |}
\hline
    \textbf{Net ID} & \textbf{Radio Technology} & \textbf{Proxied Ports} \\ \hline \hline
    Cellular 2      & HSPA                      & 21, 22, 25, 80, 110, 135, 143, 161, 465, 585, 587, 995, 1194, 1723, 5060, 6881, 9001 \\ \hline
    Cellular 4      & GPRS                      & 80, 110, 143 \\ \hline
    Cellular 4      & HSPA                      & 80, 110, 143 \\ \hline
    Cellular 4      & LTE                       & 80, 110, 143, 443, 993, 995 \\ \hline
    % T-Mobile, part of EE
    Cellular 4*     & HSPA                     & 25, 80, 110, 143 \\ \hline
    % Virgin on T-Mobile
    Cellular 4**    & HSPA                    & 25, 80, 110, 143 \\ \hline
\end{tabular}
\end{center}
}
\vspace{-2mm}
\caption{Non-transparent proxies and their proxied port numbers by radio technology}
\label{tab:proxies}
\vspace{-4mm}
\end{table}

We summarize results in Table~\ref{tab:proxies}. 3G and 4G networks use different IP core networks, therefore we split the results by radio technology. We did not detect proxies on Cellular 1 and Cellular 3 networks and did not have data about Cellular 6, but results of our TCP testsuite did not indicate any proxies. Cellular 2 proxies almost all of our tested ports except for 443 and 993.

Cellular 4 shows non-uniform behavior across the network. It is not obvious why the network proxies connections to ports commonly used for encrypted communications. Currently we have only recorded 1 such case for HTTPS. The differences between the other two cases (* and **) seem related to forming the operator from two merged ones. Their infrastructure may have not been completely consolidated: \emph{whois} records and device-reported network names are different. Case \textbf{*} shows the old operator name and \textbf{**} reports the name of a virtual network operator (MVNO). MVNOs buy network services from operators at wholesale rates and typically have little infrastructure of their own, and expect to see the same behavior as that of the underlying network.

Estimating proxying from \emph{whois} records alone is not safe: they do not necessarily match the operator names and we saw the same address ranges used with all device-reported network names for HSPA and LTE radios. Reliable detection needs active testing, potentially combined with caching for repeated connections. 

%Proxying is protocol-dependent in some cases: looking at port 80, Cellular 4\*\* modified HTTP headers, performed transcoding and reordered header fields, but only modified non-HTTP traffic for one of the two sessions. While some networks did not interfere with our tests, they do not appear to be completely free of proxies. On Cellular 1 (15 sessions) two sessions show DNS proxies (over UDP) and on Cellular 5 two sessions (out of 47) had non-HTTP traffic filtered on port 80. Finally, Cellular 2 and 4 both reorder HTTP headers and perform transcoding, but Cellular 4 does not always allow non-HTTP traffic.

%    an_op_name    | an_cell_net_type | an_country | port |    ip_global (simplified to network address. Included the owner according to whois
% db)
% -----------------+------------------+------------+------+-----------------
%  EE              | GPRS             | gb         |   80 | 31.72/19 (EE)
%  EE              | GPRS             | gb         |  110 | 31.72/19 (EE)
%  EE              | GPRS             | gb         |  143 | 31.72/19 (EE) 
%  EE              | HSPA             | gb         |   25 | 31.96/21 (EE), 149.254/16 (T-Mobile UK), 178.96/12 (EE)
%  EE              | HSPA             | gb         |   80 | 31.80/21 (EE), 31.96/21 (EE), 149.254/16 (T-Mobile UK), 178.96/12 (EE), 213.205.224/12 (EE)
%  EE              | HSPA             | gb         |  110 | 31.80/21 (EE), 31.96/21 (EE), 149.254/16 (T-Mobile UK), 178.96/12 (EE), 213.205.224/12 (EE)
%  EE              | HSPA             | gb         |  143 | 31.80/21 (EE), 31.96/21 (EE), 149.254/16 (T-Mobile UK), 178.96/12 (EE), 213.205.224/12 (EE)
%  EE              | LTE              | gb         |   80 | 31.96/21 (EE), 89.192/16 (EE), 213.205.224/12 (EE)
%  EE              | LTE              | gb         |  110 | 31.96/21 (EE), 89.192/16 (EE), 213.205.224/12 (EE)
%  EE              | LTE              | gb         |  143 | 31.96/21 (EE), 89.192/16 (EE), 213.205.224/12 (EE)
%  EE              | LTE              | gb         |  443 | 213.205.224/12 (EE)
%  EE              | LTE              | gb         |  993 | 31.96/21 (EE), 89.192/16 (EE), 213.205.224/12 (EE)
%  EE              | LTE              | gb         |  995 | 31.96/21 (EE), 89.192/16 (EE), 213.205.224/12 (EE)
%  T-Mobile        | HSPA             | gb         |   25 | 31.96/21 (EE), 149.254/16 (T-Mobile)
%  T-Mobile        | HSPA             | gb         |   80 | 31.96/21 (EE), 149.254/16 (T-Mobile)
%  T-Mobile        | HSPA             | gb         |  110 | 31.96/21 (EE), 149.254/16 (T-Mobile)
%  T-Mobile        | HSPA             | gb         |  143 | 31.96/21 (EE), 149.254/16 (T-Mobile)
%  Virgin          | HSPA             | gb         |   25 | 149.254/16 (T-Mobile)
%  Virgin          | HSPA             | gb         |   80 | 149.254/16 (T-Mobile)
%  Virgin          | HSPA             | gb         |  110 | 149.254/16 (T-Mobile)
%  Virgin          | HSPA             | gb         |  143 | 149.254/16 (T-Mobile)
%  giffgaff        | HSPA             | gb         |   21 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |   22 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |   25 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |   80 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  110 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  135 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  143 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  161 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  465 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  585 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  587 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         |  995 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         | 1194 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         | 1723 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         | 5060 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         | 6881 | 82.132/16 (O2)
%  giffgaff        | HSPA             | gb         | 9001 | 82.132/16 (O2)


\section{Control information exchange}
\label{sec:protocol}

What is common to all candidate protocol changes described above is that they are very limited in size and therefore sufficient to exchange an opcode or an ID. Other protocol details must instead be exchanged either out of band, implicit to the opcode, or explicitly by redefining the meaning of part of the data payload or previously exchanged information. Here we propose one way of exchanging control information as an opcode to bootstrap a full control stream.

\subsection{Opcode embedding}

A surprising result in our tests is that the \emph{Acknowledgment Number} field without the ACK flag set is passed on all non-proxied connections. In addition, it is a 32-bit value and we can allocate part of it (\eg 8 or 16 bits) to signal that the rest of the field is significant. The exact allocation is subject to further discussion, but we suggest using the first 16 bits as \emph{Extension Space} and the others as $Opcode$ (Figure~\ref{fig:header}), carrying the desired opcode. For simultaneous open we can use the same mechanism in both directions.

For acknowledging extensions in SYN-ACK packet we use Urgent Pointer and Checksum fields. Our tests indicate that neither choice is guaranteed to succeed, therefore we combine the two by redefining their values when SYN=1. We define Urgent Pointer to be $Opcode_U$ when URG=0 and Checksum to carry a meaning when Urgent Pointer = 0 to get around the cases where one is blocked but the other one is not. Across all networks we have tested in our preliminary study at least one of the choices succeeds.

Checksum value can not be used directly as an opcode since it changes at every level of NAT. The traditional NAT does a simple recalculation of the checksum~\cite{Egevang:tu}: subtracts the original source address and port number (in some cases also the sequence number) and adds the new values. The received Checksum after \(n\) NAT hops is therefore

\vspace{-2mm}
\begin{align*}
Checksum_2 & = Checksum_1 - header_1 + header_2 \\
Checksum_i & = Checksum_{i-1} - header_{i-1} + header_i \\
 ... \\
Checksum_n & = Checksum_1 - header_1 + header_n
\end{align*}

Here $header$ refers to the fields of the header that change, namely the destination port number, address and sequence number. Previous study~\cite{UntoldMiddlebox2011} found no NATs mangling sequence numbers, but we witnessed a few cases of such behavior. The Opcode can then be encoded as a target checksum so that it is recoverable by a simple binary subtraction of the changing fields (3 to 7 16-bit arithmetic operations in total):

\vspace{-2mm}
\begin{align*}
Checksum_{target} & = Opcode + header_1 \\
Checksum_n = Opcode_C & = Opcode + header_n
\end{align*}

There are two choices for setting checksum to a specific value: invalid checksum or adding padding payload. The latter can only be done when the receiving end is already expecting it, since it should not pass such payload up to the layer above, but keeps a packet valid from network's perspective.

For our prototype we assign the first 16 bits of the payload as \emph{Checksum Correction} to force a specific checksum, in line with other extensions which reuse part of data payload for option negotiation and maintaining validity of a packet. This Checksum Correction field is not delivered to the application. TLV-Encoded (Type-Length-Value) Control Stream can be present in data part~\cite{Bonaventure:wx} of the SYN-ACK packet after the Checksum Correction field.

Sending data with SYN-ACK packet works on all tested cellular networks, but does not on most WiFi. For the above header modifications the information either reaches the destination as intended, or the packet is dropped. Finally, on all of our tested networks at least one case succeeds as long as there is no non-transparent proxy for the chosen destination port.

\subsection{Bootstrapping control stream}

We use the embedded opcodes in the handshake to exchange sufficient control information to bootstrap a complete control stream. We extend the three-way handshake with fields shown in Figure~\ref{fig:header}:

\begin{enumerate}
\item \textbf{SYN}: the active opener sends SYN packet with \emph{$Opcode Namespace$ + $Opcode$} and ACK unset.
\item \textbf{SYN-ACK}: if passive opener recognizes the namespace and the $Opcode$, it replies with SYN-ACK with $Opcode_U$ = $Opcode$ (URG unset) to acknowledge the Opcode.
\item If passive opener does not receive an ACK, retransmit with $Opcode_C$ and \emph{Checksum Correction}. If that fails as well, retransmit SYN-ACK with an invalid checksum. Finally, fall back to vanilla TCP and retransmit a standard SYN-ACK.
\item \textbf{ACK}: when active opener receives a packet, it checks for $Opcode_U$ (if URG is unset). Otherwise, it checks if Checksum = $Opcode_C$ as described above. If no Opcode is recoverable, fall back to vanilla TCP and transmit a standard ACK.
\item Otherwise both openers recognize the $Opcode$. Active opener sends an ACK packet with TLV-encoded control information in packet payload. The control stream has been successfully bootstrapped.
\end{enumerate}

\begin{figure}[t!]
\centering
\includegraphics[width=.9\columnwidth]{figs/handshake}
% \vspace{-2mm}
\caption{Example handshake with extension negotiation}
\label{fig:handshake}
\vspace{-4mm}
\end{figure}

Figure~\ref{fig:handshake} shows an example handshake. In this case a client (active opener) sends a SYN packet as show above. The packet traverses a middlebox that does not remove the opcode and reaches the Server (passive opener). The Server replies with SYN-ACK with U\_Opcode, but the middlebox discards it. The server then retransmits SYN-ACK with $Opcode_C$ and Checksum Correction bits, delivered to the Client. The client recovers and verifies the received opcode. Hence both endpoints understand the meaning of the opcode, therefore the client replies with an ACK with control information acknowledging reception of the $Opcode$ from the Server.

We witnessed a case of packet splitting where an ACK segment is split to one only acknowledging the received data and another other one with the actual payload. We did not observe a case where a middlebox both passes payload in SYN-ACK packet and splits ACK segments. If the handshake succeeds we need to take a little extra care with the fallback mechanism -- we need to wait for an ACK segment with payload before falling back to vanilla TCP. If the passive opener receives data it can not decode as valid TLV-encoded control information, it falls back to vanilla TCP.

Putting control stream into packet payload suffers from much the same issues as other proposals to extend TCP option space~\cite{Ramaiah:2012wa}. The premise of our work is that middleboxes should not be aware of the new control streams in the first place and therefore not interfere with them. Currently we focus on exchanging control information within the packet header and leave refinement of the full control channel for future work.

\subsection{Control channel bitrate}

In progress...

\section{Related Work}
\label{sec:related}

Steganography has been used in the past to hide information within network protocols. The main focus has been on covert channels that violate system's security policy and initial sequence numbers~\cite{Rowland:1997vq}, TCP Timestamps~\cite{Giffin:2002wh} and combinations with IP flags~\cite{Murdoch:2005fz}. There are detection techniques for these methods and our main goal is to exchange a small amount of control information rather than a genuine covert channel, asking for a different design.

TCP implements an \emph{urgent mechanism} at its core that allows the sending user to stimulate the receiving user to accept some \emph{urgent data}. The mechanism is often quoted as providing ``out-of-bound'' data delivery even though it is explicitly not designed as a mechanism for sending such data. Furthermore, there are ambiguities regarding the semantics of the urgent pointer, Network Intrusion Detection Systems (NIDS) tend to clear the URG flag and pointer and the general recommendation is against the use of the mechanism~\cite{Gont:2011vi}.

AccECN proposal~\cite{Kuhlewind:2014vd} uses an additional reserved bit, overloads the meaning of already assigned ECN~\cite{Floyd:up} and NS~\cite{Ely:uc} bits and redefines Urgent Pointer as Non-Urgent when URG is not set. The idea is highly related to ours, but reserving the field solely for ECN use prevents other extensions from using. Furthermore, we saw that some networks block packets with such field, making it especially difficult to use for ECN.

Generic control stream for MPTCP~\cite{Bonaventure:wx} is another alternative. It proposes the mapping control stream into a separate sequence number space and exchange control data over established subflows, only modifying the MPTCP DSS option to differentiate control and data streams. The underlying assumption, however, is that MPTCP is already deployed and that existing deployments will be compatible with the new specification.

\section{Discussion}

The main points of discussion on \emph{NoTCP} are the same as with all TCP extensions: is it necessary, deployable and forwards-compatible? We have discussed the first two throughout the paper, but the biggest challenge for forwards-compatibility is NoTCP's overloading of header fields instead of using options.

The exact protocol semantics are subject to further testing and discussions. The main goal of this work is to identify potential methods for exchanging control information by hiding it from existing middleboxes.

In the long term and beyond our example control information exchange we believe that each protocol-relate standards (TCP extensions in this case) should explicitly define all header fields it interferes with and how. Examples include extending sequence numbers and using stronger message integrity checks~\cite{Mazieres:uz}, changing semantics of duplicate ACKs~\cite{Handley:vj,Flach:2013uy} or even simple checksum or window size modifications.

More importantly, we have left open the question of finding a method to hide such information from non-transparent proxies. The easiest, albeit limited solution is to identify and cache port numbers that allow unmodified traffic. Instead we plan to study commonly found proxy implementations in detail in order to quickly identify them and encode information within their own operating patterns.

Finally, we hope to map header field modifications by existing extensions and network middleboxes into an algebraic form as we have done in the simple case of checksum. This way we would not only be able to exchange control information across the network reliably, but also identify network path behavior by looking at its performed operations. This way extending a protocol would become a matter of defining a new set of such header algebra rules and simplify the process of design and testing.

\section{Conclusion}

Our hope is to motivate the research community into exploring the full range of possibilities in this space and to encourage more people to install our application so that we can build a comprehensive database of middlebox interference with protocols across different network providers.

The study will explore new ways of exchanging control information resilient to major classes of deployed middleboxes by using steganographic approaches. We would like to use the results of the study to develop a set of rules for how protocol extensions redefine and how middleboxes modify packet headers. Development of such ruleset would  mean that extending a protocol in the future could become near automatic.

\ifnum\anon=0
\subsection*{Acknowledgments}

\fi


\clearpage
%Only show things we really cite :)
% \nocite{*}
{

\bibliographystyle{abbrv}
\small 
\bibliography{references}
}

%\appendix 
%\input{data}

\end{document}







